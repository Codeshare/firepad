!function(t,e,r){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof r.define&&r.define.amd?define(e):r.Firepad=e()}(0,function(){var t;return(t=t||{}).utils={},t.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,r){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:r})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var r=this.eventListeners_[t]||[],n=0;n<r.length;n++)if(r[n].callback===e)return void r.splice(n,1)},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],r=0;r<e.length;r++)e[r].callback.apply(e[r].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_){for(var e=!1,r=0;r<this.allowedEvents_.length;r++)if(this.allowedEvents_[r]===t){e=!0;break}if(!e)throw new Error('Unknown event "'+t+'"')}}},t.utils.elt=function(e,r,n){var i=document.createElement(e);if("string"==typeof r)t.utils.setTextContent(i,r);else if(r)for(var o=0;o<r.length;++o)i.appendChild(r[o]);for(var s in n||{})i.setAttribute(s,n[s]);return i},t.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},t.utils.on=function(t,e,r,n){t.addEventListener?t.addEventListener(e,r,n||!1):t.attachEvent&&t.attachEvent("on"+e,r)},t.utils.off=function(t,e,r,n){t.removeEventListener?t.removeEventListener(e,r,n||!1):t.detachEvent&&t.detachEvent("on"+e,r)},t.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},t.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},t.utils.stopEvent=function(e){t.utils.preventDefault(e),t.utils.stopPropagation(e)},t.utils.stopEventAnd=function(e){return function(r){return e(r),t.utils.stopEvent(r),!1}},t.utils.trim=function(t){return t.replace(/^\s+/g,"").replace(/\s+$/g,"")},t.utils.stringEndsWith=function(t,e){for(var r="string"==typeof e?[e]:e,n=0;n<r.length;n++){e=r[n];if(-1!==t.indexOf(e,t.length-e.length))return!0}return!1},t.utils.assert=function(t,e){if(!t)throw new Error(e||"assertion error")},t.utils.log=function(){if("undefined"!=typeof console&&void 0!==console.log){for(var t=["Firepad:"],e=0;e<arguments.length;e++)t.push(arguments[e]);console.log.apply(console,t)}},(t=t||{}).Span=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}(),(t=t||{}).TextOp=function(){var e=t.utils;function r(t){this.type=t,this.chars=null,this.text=null,this.attributes=null,"insert"===t?(this.text=arguments[1],e.assert("string"==typeof this.text),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes)):"delete"===t?(this.chars=arguments[1],e.assert("number"==typeof this.chars)):"retain"===t&&(this.chars=arguments[1],e.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes))}return r.prototype.isInsert=function(){return"insert"===this.type},r.prototype.isDelete=function(){return"delete"===this.type},r.prototype.isRetain=function(){return"retain"===this.type},r.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},r.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},r.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},r}(),(t=t||{}).TextOperation=function(){"use strict";var e=t.TextOp,r=t.utils;function n(){if(!this||this.constructor!==n)return new n;this.ops=[],this.baseLength=0,this.targetLength=0}function i(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function o(t){return t.ops[0].isRetain()?t.ops[0].chars:0}return n.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},n.prototype.retain=function(t,r){if("number"!=typeof t||t<0)throw new Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,r=r||{};var n=this.ops.length>0?this.ops[this.ops.length-1]:null;return n&&n.isRetain()&&n.attributesEqual(r)?n.chars+=t:this.ops.push(new e("retain",t,r)),this},n.prototype.insert=function(t,r){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;r=r||{},this.targetLength+=t.length;var n=this.ops.length>0?this.ops[this.ops.length-1]:null,i=this.ops.length>1?this.ops[this.ops.length-2]:null;return n&&n.isInsert()&&n.attributesEqual(r)?n.text+=t:n&&n.isDelete()?i&&i.isInsert()&&i.attributesEqual(r)?i.text+=t:(this.ops[this.ops.length-1]=new e("insert",t,r),this.ops.push(n)):this.ops.push(new e("insert",t,r)),this},n.prototype.delete=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||t<0)throw new Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var r=this.ops.length>0?this.ops[this.ops.length-1]:null;return r&&r.isDelete()?r.chars+=t:this.ops.push(new e("delete",t)),this},n.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},n.prototype.clone=function(){for(var t=new n,e=0;e<this.ops.length;e++)this.ops[e].isRetain()?t.retain(this.ops[e].chars,this.ops[e].attributes):this.ops[e].isInsert()?t.insert(this.ops[e].text,this.ops[e].attributes):t.delete(this.ops[e].chars);return t},n.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],r=0,n=this.length;r<n;r++)e[r]=t(this[r]);return e}).call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},n.prototype.toJSON=function(){for(var t=[],e=0;e<this.ops.length;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},n.fromJSON=function(t){for(var e=new n,i=0,o=t.length;i<o;i++){var s=t[i],a={};"object"==typeof s&&(a=s,s=t[++i]),"number"==typeof s?s>0?e.retain(s,a):e.delete(-s):(r.assert("string"==typeof s),e.insert(s,a))}return e},n.prototype.apply=function(t,e,n){if(e=e||[],n=n||[],t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var i,o,s=[],a=0,h=0,u=this.ops,c=0,p=u.length;c<p;c++){var l=u[c];if(l.isRetain()){if(h+l.chars>t.length)throw new Error("Operation can't retain more characters than are left in the string.");for(s[a++]=t.slice(h,h+l.chars),i=0;i<l.chars;i++){var d=e[h+i]||{},f={};for(o in d)f[o]=d[o],r.assert(!1!==f[o]);for(o in l.attributes)!1===l.attributes[o]?delete f[o]:f[o]=l.attributes[o],r.assert(!1!==f[o]);n.push(f)}h+=l.chars}else if(l.isInsert())for(s[a++]=l.text,i=0;i<l.text.length;i++){var g={};for(o in l.attributes)g[o]=l.attributes[o],r.assert(!1!==g[o]);n.push(g)}else h+=l.chars}if(h!==t.length)throw new Error("The operation didn't operate on the whole string.");var y=s.join("");return r.assert(y.length===n.length),y},n.prototype.invert=function(t){for(var e=0,r=new n,i=this.ops,o=0,s=i.length;o<s;o++){var a=i[o];a.isRetain()?(r.retain(a.chars),e+=a.chars):a.isInsert()?r.delete(a.text.length):(r.insert(t.slice(e,e+a.chars)),e+=a.chars)}return r},n.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");function e(t,e,r){var n,i={};for(n in t)i[n]=t[n];for(n in e)r&&!1===e[n]?delete i[n]:i[n]=e[n];return i}for(var r,i=new n,o=this.clone().ops,s=t.clone().ops,a=0,h=0,u=o[a++],c=s[h++];void 0!==u||void 0!==c;)if(u&&u.isDelete())i.delete(u.chars),u=o[a++];else if(c&&c.isInsert())i.insert(c.text,c.attributes),c=s[h++];else{if(void 0===u)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===c)throw new Error("Cannot compose operations: first operation is too long.");if(u.isRetain()&&c.isRetain())r=e(u.attributes,c.attributes),u.chars>c.chars?(i.retain(c.chars,r),u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(i.retain(u.chars,r),u=o[a++],c=s[h++]):(i.retain(u.chars,r),c.chars-=u.chars,u=o[a++]);else if(u.isInsert()&&c.isDelete())u.text.length>c.chars?(u.text=u.text.slice(c.chars),c=s[h++]):u.text.length===c.chars?(u=o[a++],c=s[h++]):(c.chars-=u.text.length,u=o[a++]);else if(u.isInsert()&&c.isRetain())r=e(u.attributes,c.attributes,!0),u.text.length>c.chars?(i.insert(u.text.slice(0,c.chars),r),u.text=u.text.slice(c.chars),c=s[h++]):u.text.length===c.chars?(i.insert(u.text,r),u=o[a++],c=s[h++]):(i.insert(u.text,r),c.chars-=u.text.length,u=o[a++]);else{if(!u.isRetain()||!c.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(u)+", op2: "+JSON.stringify(c));u.chars>c.chars?(i.delete(c.chars),u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(i.delete(c.chars),u=o[a++],c=s[h++]):(i.delete(u.chars),c.chars-=u.chars,u=o[a++])}}return i},n.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=o(this),r=o(t),n=i(this),s=i(t);return!(!n||!s)&&(n.isInsert()&&s.isInsert()?e+n.text.length===r:!(!n.isDelete()||!s.isDelete())&&(r+s.chars===e||e===r))},n.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=o(this),r=o(t),n=i(this),s=i(t);return!(!n||!s)&&(n.isInsert()&&s.isInsert()?e+n.text.length===r||e===r:!(!n.isDelete()||!s.isDelete())&&r+s.chars===e)},n.transformAttributes=function(t,e){var n,i={},o={},s={};for(n in t)s[n]=!0;for(n in e)s[n]=!0;for(n in s){var a=t[n],h=e[n];r.assert(null!=a||null!=h),null==a?o[n]=h:null==h?i[n]=a:a===h||(i[n]=a)}return[i,o]},n.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var r=new n,i=new n,o=t.clone().ops,s=e.clone().ops,a=0,h=0,u=o[a++],c=s[h++];void 0!==u||void 0!==c;)if(u&&u.isInsert())r.insert(u.text,u.attributes),i.retain(u.text.length),u=o[a++];else if(c&&c.isInsert())r.retain(c.text.length),i.insert(c.text,c.attributes),c=s[h++];else{if(void 0===u)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===c)throw new Error("Cannot transform operations: first operation is too long.");var p;if(u.isRetain()&&c.isRetain()){var l=n.transformAttributes(u.attributes,c.attributes);u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=c.chars,u=o[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=o[a++]),r.retain(p,l[0]),i.retain(p,l[1])}else if(u.isDelete()&&c.isDelete())u.chars>c.chars?(u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(u=o[a++],c=s[h++]):(c.chars-=u.chars,u=o[a++]);else if(u.isDelete()&&c.isRetain())u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=c.chars,u=o[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=o[a++]),r.delete(p);else{if(!u.isRetain()||!c.isDelete())throw new Error("The two operations aren't compatible");u.chars>c.chars?(p=c.chars,u.chars-=c.chars,c=s[h++]):u.chars===c.chars?(p=u.chars,u=o[a++],c=s[h++]):(p=u.chars,c.chars-=u.chars,u=o[a++]),i.delete(p)}}return[r,i]},n.prototype.transform=function(t){return n.transform(this,t)},n}(),(t=t||{}).AnnotationList=function(){var e=t.Span;function r(t,e){if(!t)throw new Error("AnnotationList assertion failed"+(e?": "+e:""))}function n(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function i(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}n.prototype.getAttachedObject=function(){return this.attachedObject_},i.prototype.attachObject=function(t){this.node_.attachedObject=t};var o={equals:function(){return!1}};function s(t){this.head_=new a(0,o),this.changeHandler_=t}function a(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}return s.prototype.insertAnnotatedSpan=function(t,n){this.wrapOperation_(new e(t.pos,0),function(e,i){r(!i||null===i.next);var s=new a(t.length,n);if(i){r(t.pos>e&&t.pos<e+i.length);var h=new a(0,o);return h.next=new a(t.pos-e,i.annotation),h.next.next=s,s.next=new a(e+i.length-t.pos,i.annotation),h.next}return s})},s.prototype.removeSpan=function(t){0!==t.length&&this.wrapOperation_(t,function(e,n){r(null!==n);var i=new a(0,o),s=i;for(t.pos>e&&(s.next=new a(t.pos-e,n.annotation),s=s.next);t.end()>e+n.length;)e+=n.length,n=n.next;var h=e+n.length-t.end();return h>0&&(s.next=new a(h,n.annotation)),i.next})},s.prototype.updateSpan=function(t,e){0!==t.length&&this.wrapOperation_(t,function(n,i){r(null!==i);var s=new a(0,o),h=s,u=n,c=t.pos-u;for(r(c<i.length),c>0&&(h.next=new a(c,i.annotation),u+=(h=h.next).length);null!==i&&t.end()>=n+i.length;){var p=n+i.length-u;h.next=new a(p,e(i.annotation,p)),h=h.next,n+=i.length,i=i.next,u=n}var l=t.end()-u;return l>0&&(r(l<i.length),h.next=new a(l,e(i.annotation,l)),u+=(h=h.next).length,h.next=new a(n+i.length-u,i.annotation)),s.next})},s.prototype.wrapOperation_=function(t,e){if(t.pos<0)throw new Error("Span start cannot be negative.");var r,o=[],s=[],h=this.getAffectedNodes_(t);null!==h.start?(r=h.end.next,h.end.next=null):r=h.succ;var u=e(h.startPos,h.start),c=!1,p=!1;if(u){var l;for(this.mergeNodesWithSameAnnotations_(u),h.pred&&h.pred.annotation.equals(u.annotation)?(c=!0,u.length+=h.pred.length,h.beforePred.next=u,l=h.predPos):(h.beforeStart.next=u,l=h.startPos);u.next;)s.push(new i(l,u)),l+=u.length,u=u.next;h.succ&&h.succ.annotation.equals(u.annotation)?(u.length+=h.succ.length,p=!0,u.next=h.succ.next):u.next=r,s.push(new i(l,u))}else h.pred&&h.succ&&h.pred.annotation.equals(h.succ.annotation)?(c=!0,p=!0,u=new a(h.pred.length+h.succ.length,h.pred.annotation),h.beforePred.next=u,u.next=h.succ.next,s.push(new i(h.startPos-h.pred.length,u))):h.beforeStart.next=r;c&&o.push(new n(h.predPos,h.pred));for(var d=h.startPos,f=h.start;null!==f;)o.push(new n(d,f)),d+=f.length,f=f.next;p&&o.push(new n(d,h.succ)),this.changeHandler_(o,s)},s.prototype.getAffectedNodes_=function(t){for(var e={},r=null,n=this.head_,i=n.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,r=n,n=i,i=i.next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=n,o===t.pos&&o>0?(e.pred=n,e.predPos=o-n.length,e.beforePred=r):e.pred=null;null!==i&&t.end()>o;)o+=i.length,n=i,i=i.next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=n,e.succ=o===t.end()?i:null,e},s.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,r=t;r;)e&&e.annotation.equals(r.annotation)?(e.length+=r.length,e.next=r.next):e=r,r=r.next},s.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},s.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,r=this.head_.next,i=null;null!==r&&e+r.length<=t;)e+=r.length,i=r,r=r.next;if(null===r&&e!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var o=[];return e===t&&i&&o.push(new n(e-i.length,i)),r&&o.push(new n(e,r)),o},s.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var r=[],n=this.getAffectedNodes_(t),i=n.startPos,o=n.start;null!==o&&i<t.end();){var s=Math.max(i,t.pos),a=Math.min(i+o.length,t.end()),h=new e(s,a-s);h.annotation=o.annotation,r.push(h),i+=o.length,o=o.next}return r},s.prototype.count=function(){for(var t=0,e=this.head_.next,n=null;null!==e;)n&&r(!n.annotation.equals(e.annotation)),n=e,e=e.next,t++;return t},a.prototype.clone=function(){var t=new a(this.spanLength,this.annotation);return t.next=this.next,t},s}(),(t=t||{}).Cursor=function(){"use strict";function t(t,e){this.position=t,this.selectionEnd=e}return t.fromJSON=function(e){return new t(e.position,e.selectionEnd)},t.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},t.prototype.compose=function(t){return t},t.prototype.transform=function(e){function r(t){for(var r=t,n=e.ops,i=0,o=e.ops.length;i<o&&(n[i].isRetain()?t-=n[i].chars:n[i].isInsert()?r+=n[i].text.length:(r-=Math.min(t,n[i].chars),t-=n[i].chars),!(t<0));i++);return r}var n=r(this.position);return this.position===this.selectionEnd?new t(n,n):new t(n,r(this.selectionEnd))},t}(),(t=t||{}).WrappedOperation=function(t){"use strict";function e(t,e){this.wrapped=t,this.meta=e}function r(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function n(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return e.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},e.prototype.invert=function(){var t=this.meta;return new e(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},e.prototype.compose=function(t){return new e(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var n={};return r(t,n),r(e,n),n}return e}(this.meta,t.meta))},e.transform=function(t,r){var i=t.wrapped.transform(r.wrapped);return[new e(i[0],n(t.meta,r.wrapped)),new e(i[1],n(r.meta,t.wrapped))]},e.prototype.transform=function(t){return e.transform(this,t)},e}(),(t=t||{}).UndoManager=function(){"use strict";var t="normal";function e(e){this.maxItems=e||50,this.state=t,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function r(t,e){for(var r=[],n=e.constructor,i=t.length-1;i>=0;i--){var o=n.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||r.push(o[0]),e=o[1]}return r.reverse()}return e.prototype.add=function(t,e){if("undoing"===this.state)this.redoStack.push(t),this.dontCompose=!0;else if("redoing"===this.state)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&r.length>0?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},e.prototype.transform=function(t){this.undoStack=r(this.undoStack,t),this.redoStack=r(this.redoStack,t)},e.prototype.performUndo=function(e){if(this.state="undoing",0===this.undoStack.length)throw new Error("undo not possible");e(this.undoStack.pop()),this.state=t},e.prototype.performRedo=function(e){if(this.state="redoing",0===this.redoStack.length)throw new Error("redo not possible");e(this.redoStack.pop()),this.state=t},e.prototype.canUndo=function(){return 0!==this.undoStack.length},e.prototype.canRedo=function(){return 0!==this.redoStack.length},e.prototype.isUndoing=function(){return"undoing"===this.state},e.prototype.isRedoing=function(){return"redoing"===this.state},e}(),(t=t||{}).Client=function(){"use strict";function t(){this.state=r}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(e),new n(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.serverRetry=function(t){throw new Error("There is no pending operation.")};var r=new e;function n(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return t.AwaitingConfirm=n,n.prototype.applyClient=function(t,e){return new i(this.outstanding,e)},n.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e);return t.applyOperation(r[1]),new n(r[0])},n.prototype.serverAck=function(t){return r},n.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},t.AwaitingWithBuffer=i,i.prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new i(this.outstanding,r)},i.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e),n=this.buffer.transform(r[1]);return t.applyOperation(n[1]),new i(r[0],n[0])},i.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new n(e)},i.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new n(this.buffer)},t}(),(t=t||{}).EditorClient=function(){"use strict";var e=t.Client,r=t.Cursor,n=t.UndoManager,i=t.WrappedOperation;function o(t,e){this.cursorBefore=t,this.cursorAfter=e}function s(t,e){this.id=t,this.editorAdapter=e}function a(t,i){e.call(this),this.serverAdapter=t,this.editorAdapter=i,this.undoManager=new n,this.clients={};var o=this;this.editorAdapter.registerCallbacks({change:function(t,e){o.onChange(t,e)},cursorActivity:function(){o.onCursorActivity()},blur:function(){o.onBlur()},focus:function(){o.onFocus()}}),this.editorAdapter.registerUndo(function(){o.undo()}),this.editorAdapter.registerRedo(function(){o.redo()}),this.serverAdapter.registerCallbacks({ack:function(){o.serverAck(),o.focused&&o.state instanceof e.Synchronized&&(o.updateCursor(),o.sendCursor(o.cursor)),o.emitStatus()},retry:function(){o.serverRetry()},operation:function(t){o.applyServer(t)},cursor:function(t,n,i){if(o.serverAdapter.userId_!==t&&o.state instanceof e.Synchronized){var s=o.getClientObject(t);n?(i&&s.setColor(i),s.updateCursor(r.fromJSON(n))):s.removeCursor()}}})}return o.prototype.invert=function(){return new o(this.cursorAfter,this.cursorBefore)},o.prototype.compose=function(t){return new o(this.cursorBefore,t.cursorAfter)},o.prototype.transform=function(t){return new o(this.cursorBefore?this.cursorBefore.transform(t):null,this.cursorAfter?this.cursorAfter.transform(t):null)},s.prototype.setColor=function(t){this.color=t},s.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id)},s.prototype.removeCursor=function(){this.mark&&this.mark.clear()},function(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}(a,e),a.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new s(t,this.editorAdapter))},a.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},a.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},a.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},a.prototype.onChange=function(t,e){var r=this.cursor;this.updateCursor();var n,s=this.undoManager.undoStack.length>0&&e.shouldBeComposedWithInverted((n=this.undoManager.undoStack,n[n.length-1]).wrapped),a=new o(this.cursor,r);this.undoManager.add(new i(e,a),s),this.applyClient(t)},a.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},a.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),!this.focused||t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},a.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},a.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},a.prototype.sendCursor=function(t){this.state instanceof e.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},a.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t),this.emitStatus()},a.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new i(t,null))},a.prototype.emitStatus=function(){var t=this;setTimeout(function(){t.trigger("synced",t.state instanceof e.Synchronized)},0)},a}(),t.utils.makeEventEmitter(t.EditorClient,["synced"]),(t=t||{}).AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt"},t.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""},(t=t||{}).EntityManager=function(){var e=t.utils;function r(){this.entities_={};var t=["src","alt","width","height","style","class"];this.register("img",{render:function(t){e.assert(t.src,"image entity should have 'src'!");for(var r=["src","alt","width","height","style","class"],n="<img ",i=0;i<r.length;i++){var o=r[i];o in t&&(n+=" "+o+'="'+t[o]+'"')}return n+=">"},fromElement:function(e){for(var r={},n=0;n<t.length;n++){var i=t[n];e.hasAttribute(i)&&(r[i]=e.getAttribute(i))}return r}})}return r.prototype.register=function(e,r){t.utils.assert(r.render,"Entity options should include a 'render' function!"),t.utils.assert(r.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[e]=r},r.prototype.renderToElement=function(t,e){return this.tryRenderToElement_(t,"render",e)},r.prototype.exportToElement=function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-firepad-entity",t.type),e},r.prototype.updateElement=function(t,e){var r=t.type,n=t.info;this.entities_[r]&&void 0!==this.entities_[r].update&&this.entities_[r].update(n,e)},r.prototype.fromElement=function(e){var r=e.getAttribute("data-firepad-entity");if(r||(r=e.nodeName.toLowerCase()),r&&this.entities_[r]){var n=this.entities_[r].fromElement(e);return new t.Entity(r,n)}},r.prototype.tryRenderToElement_=function(e,r,n){var i=e.type,o=e.info;if(this.entities_[i]&&this.entities_[i][r]){var s=t.document||window&&window.document,a=this.entities_[i][r](o,n,s);if(a){if("string"==typeof a){var h=(t.document||document).createElement("div");return h.innerHTML=a,h.childNodes[0]}if("object"==typeof a)return t.utils.assert(void 0!==a.nodeType,"Error rendering "+i+" entity.  render() function must return an html string or a DOM element."),a}}},r.prototype.entitySupportsUpdate=function(t){return this.entities_[t]&&this.entities_[t].update},r}(),(t=t||{}).Entity=function(){var e=t.AttributeConstants.ENTITY_SENTINEL,r=e+"_";function n(t,e){if(!(this instanceof n))return new n(t,e);this.type=t,this.info=e||{}}return n.prototype.toAttributes=function(){var t={};for(var n in t[e]=this.type,this.info)t[r+n]=this.info[n];return t},n.fromAttributes=function(t){var i=t[e],o={};for(var s in t)0===s.indexOf(r)&&(o[s.substr(r.length)]=t[s]);return new n(i,o)},n}(),(t=t||{}).RichTextCodeMirror=function(){var e=t.AnnotationList,r=t.Span,n=t.utils,i=t.AttributeConstants,o={c:"color",bc:"background-color",fs:"font-size",li:function(t){return"padding-left: "+40*t+"px"}},s={};function a(t,r,n){this.codeMirror=t,this.options_=n||{},this.entityManager_=r,this.currentAttributes_=null;var i=this;this.annotationList_=new e(function(t,e){i.onAnnotationsChanged_(t,e)}),this.initAnnotationList_(),f(this,"onCodeMirrorBeforeChange_"),f(this,"onCodeMirrorChange_"),f(this,"onCursorActivity_"),parseInt(CodeMirror.version)>=4?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[]}n.makeEventEmitter(a,["change","attributesChange","newLine"]);var h=t.sentinelConstants.LINE_SENTINEL_CHARACTER,u=t.sentinelConstants.ENTITY_SENTINEL_CHARACTER;function c(t,e){return t.line-e.line||t.ch-e.ch}function p(t,e){return c(t,e)<=0}function l(t){if(0===t.length)return 0;for(var e=0,r=0;r<t.length;r++)e+=t[r].length;return e+t.length-1}function d(t){this.attributes=t||{}}function f(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}return a.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},a.prototype.toggleAttribute=function(t,e){var r=e||!0;if(this.emptySelection_()){var n=this.getCurrentAttributes_();n[t]===r?delete n[t]:n[t]=r,this.currentAttributes_=n}else{var i=this.getCurrentAttributes_()[t]!==r&&r;this.setAttribute(t,i)}},a.prototype.setAttribute=function(t,e){var r=this.codeMirror;if(this.emptySelection_()){var n=this.getCurrentAttributes_();!1===e?delete n[t]:n[t]=e,this.currentAttributes_=n}else this.updateTextAttributes(r.indexFromPos(r.getCursor("start")),r.indexFromPos(r.getCursor("end")),function(r){!1===e?delete r[t]:r[t]=e}),this.updateCurrentAttributes_()},a.prototype.updateTextAttributes=function(t,e,n,o,s){var a=[],h=t,u=this;this.annotationList_.updateSpan(new r(t,e-t),function(t,e){var r={};for(var c in t.attributes)r[c]=t.attributes[c];r[i.LINE_SENTINEL]&&!s||n(r);var p={},l={};return u.computeChangedAttributes_(t.attributes,r,p,l),function(t){for(var e in t)return!1;return!0}(p)||a.push({start:h,end:h+e,attributes:p,attributesInverse:l,origin:o}),h+=e,new d(r)}),a.length>0&&this.trigger("attributesChange",this,a)},a.prototype.computeChangedAttributes_=function(t,e,r,n){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(r[i]=e[i],n[i]=t[i]):(r[i]=e[i],n[i]=!1):(r[i]=!1,n[i]=t[i])},a.prototype.toggleLineAttribute=function(t,e){var r,n=this.getCurrentLineAttributes_();r=!(t in n&&n[t]===e)&&e,this.setLineAttribute(t,r)},a.prototype.setLineAttribute=function(t,e){this.updateLineAttributesForSelection(function(r){!1===e?delete r[t]:r[t]=e})},a.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,r=e.getCursor("start"),n=e.getCursor("end"),i=r.line,o=n.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,n.ch));o>i&&a&&o--,this.updateLineAttributes(i,o,t)},a.prototype.updateLineAttributes=function(t,e,r){for(var n=t;n<=e;n++){var o=this.codeMirror.getLine(n),s=this.codeMirror.indexFromPos({line:n,ch:0});if(o[0]!==h){var a={};a[i.LINE_SENTINEL]=!0,r(a),this.insertText(s,h,a)}else this.updateTextAttributes(s,s+1,r,null,!0)}},a.prototype.replaceText=function(t,e,r,n,i){this.changeId_++;var o="cmrt-"+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:n};var s=this.codeMirror,a=s.posFromIndex(t),h="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(r,a,h,o)},a.prototype.insertText=function(t,e,r,n){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"==n&&!i.somethingSelected()&&t==i.indexFromPos(o);this.replaceText(t,null,e,r,n),s&&i.setCursor(o)},a.prototype.removeText=function(t,e,r){var n=this.codeMirror;n.replaceRange("",n.posFromIndex(t),n.posFromIndex(e),r)},a.prototype.insertEntityAtCursor=function(t,e,r){var n=this.codeMirror,i=n.indexFromPos(n.getCursor("head"));this.insertEntityAt(i,t,e,r)},a.prototype.insertEntityAt=function(e,r,n,i){this.codeMirror;this.insertEntity_(e,new t.Entity(r,n),i)},a.prototype.insertEntity_=function(t,e,r){this.replaceText(t,null,u,e.toAttributes(),r)},a.prototype.getAttributeSpans=function(t,e){for(var n=[],i=this.annotationList_.getAnnotatedSpansForSpan(new r(t,e-t)),o=0;o<i.length;o++)n.push({length:i[o].length,attributes:i[o].annotation.attributes});return n},a.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},a.prototype.getRange=function(t,e){var r=this.codeMirror.posFromIndex(t),n=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(r,n)},a.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new r(0,t),new d)},a.prototype.onAnnotationsChanged_=function(t,e){var r,n={};this.tryToUpdateEntitiesInPlace(t,e);for(var o=0;o<t.length;o++){var s=t[o].annotation.attributes;i.LINE_SENTINEL in s&&(n[this.codeMirror.posFromIndex(t[o].pos).line]=!0),(r=t[o].getAttachedObject())&&r.clear()}for(o=0;o<e.length;o++){var a=e[o].annotation,h=i.LINE_SENTINEL in a.attributes,u=i.ENTITY_SENTINEL in a.attributes,c=this.codeMirror.posFromIndex(e[o].pos);if(h)n[c.line]=!0;else if(u)this.markEntity_(e[o]);else{var p=this.getClassNameForAttributes_(a.attributes);if(""!==p){var l=this.codeMirror.posFromIndex(e[o].pos+e[o].length);r=this.codeMirror.markText(c,l,{className:p}),e[o].attachObject(r)}}}for(var d in n)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(d))),this.queueLineMarking_()},a.prototype.tryToUpdateEntitiesInPlace=function(t,e){for(var r=t.length;r--;)for(var n=t[r],i=e.length;i--;){var o=e[i];if(n.pos==o.pos&&n.length==o.length&&n.annotation.attributes.ent&&n.annotation.attributes.ent==o.annotation.attributes.ent){var s=o.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(s)){t.splice(r,1),e.splice(i,1);var a=n.getAttachedObject();a.update(o.annotation.attributes),o.attachObject(a)}}}},a.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var t=this;this.lineMarkTimeout_=setTimeout(function(){t.lineMarkTimeout_=null;for(var e=[],r=0;r<t.dirtyLines_.length;r++){var n=t.codeMirror.getLineNumber(t.dirtyLines_[r]);e.push(Number(n))}t.dirtyLines_=[],e.sort(function(t,e){return t-e});var i=-1;for(r=0;r<e.length;r++){var o=e[r];o>i&&(i=t.markLineSentinelCharactersForChangedLines_(o,o))}},0)}},a.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t)),e.appendChild(r)},a.prototype.getClassNameForAttributes_=function(e){var r="";for(var n in e){var a=e[n];if(n===i.LINE_SENTINEL)t.utils.assert(!0===a,"LINE_SENTINEL attribute should be true if it exists.");else{var h=(this.options_.cssPrefix||"cmrt-")+n;if(!0!==a){n===i.FONT_SIZE&&"string"!=typeof a&&(a+="px");var u=a.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(h+="-"+u,o[n]&&(s[n]||(s[n]={}),!s[n][u])){s[n][u]=!0;var c=o[n],p="function"==typeof c?c(a):c+": "+a,l=n==i.LINE_INDENT?"pre."+h:"."+h;if(this.addStyleWithCSS_(l+" { "+p+" }"),n===i.LINE_INDENT){l="pre.CodeMirror-line."+h;this.addStyleWithCSS_(l+" { "+p+" }")}}}r=r+" "+h}}return r},a.prototype.markEntity_=function(e){for(var r=e.annotation.attributes,n=t.Entity.fromAttributes(r),i=this.codeMirror,o=this,s=[],a=0;a<e.length;a++){var h=i.posFromIndex(e.pos+a),u=i.posFromIndex(e.pos+a+1),c={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},p=this.createEntityHandle_(n,e.pos),l=this.entityManager_.renderToElement(n,p);l&&(c.replacedWith=l);var d=i.markText(h,u,c);s.push(d),p.setMarker(d)}e.attachObject({clear:function(){for(var t=0;t<s.length;t++)s[t].clear()},update:function(e){for(var r=t.Entity.fromAttributes(e),n=0;n<s.length;n++)o.entityManager_.updateElement(r,s[n].replacedWith)}}),this.queueRefresh_()},a.prototype.queueRefresh_=function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){t.codeMirror.refresh(),t.refreshTimer_=null},0))},a.prototype.createEntityHandle_=function(e,r){var n=null,i=this;function o(){if(n){var t=n.find();return t?i.codeMirror.indexFromPos(t.from):null}return r}return{find:o,remove:function(){var t=o();null!=t&&(i.codeMirror.focus(),i.removeText(t,t+1))},replace:function(r){var n=t.AttributeConstants.ENTITY_SENTINEL,s=n+"_",a=o();i.updateTextAttributes(a,a+1,function(t){for(var i in t)delete t[i];for(var o in t[n]=e.type,r)t[s+o]=r[o]})},setMarker:function(t){n=t}}},a.prototype.lineClassRemover_=function(t){var e=this.codeMirror,r=e.getLineHandle(t);return{clear:function(){e.removeLineClass(r,"text",".*")}}},a.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},a.prototype.onCodeMirrorBeforeChange_=function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var r=[],n=0;n<e.text.length;n++){var i=e.text[n];i=i.replace(new RegExp("["+h+u+"]","g"),""),r.push(i)}e.update(e.from,e.to,r)}},a.prototype.onCodeMirrorChange_=function(t,e){if("object"==typeof e.from){for(var n=[];e;)n.push(e),e=e.next;e=n}for(var i=this.convertCoordinateSystemForChanges_(e),o=[],s=0;s<i.length;s++){var a,h=i[s],u=h.start,c=(h.end,h.text),p=h.removed,l=h.origin;if(p.length>0){for(var f=this.annotationList_.getAnnotatedSpansForSpan(new r(u,p.length)),g=0,y=0;y<f.length;y++){var m=f[y];o.push({start:u,end:u+m.length,removedAttributes:m.annotation.attributes,removed:p.substr(g,m.length),attributes:{},text:"",origin:h.origin}),g+=m.length}this.annotationList_.removeSpan(new r(u,p.length))}if(c.length>0)"+input"===h.origin||"paste"===h.origin?a=this.currentAttributes_||{}:l in this.outstandingChanges_?(a=this.outstandingChanges_[l].attributes,l=this.outstandingChanges_[l].origOrigin,delete this.outstandingChanges_[l]):a={},this.annotationList_.insertAnnotatedSpan(new r(u,c.length),new d(a)),o.push({start:u,end:u,removedAttributes:{},removed:"",text:c,attributes:a,origin:l})}this.markLineSentinelCharactersForChanges_(e),o.length>0&&this.trigger("change",this,o)},a.prototype.convertCoordinateSystemForChanges_=function(t){var e=this,r=function(t){return e.codeMirror.indexFromPos(t)};function n(t,e){return function(r){return p(r,e.from)?t(r):p(e.to,r)?t({line:r.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<r.line?r.ch:e.text.length<=1?r.ch-(e.to.ch-e.from.ch)+l(e.text):r.ch-e.to.ch+(n=e.text,n[n.length-1]).length})+l(e.removed)-l(e.text):e.from.line===r.line?t(e.from)+r.ch-e.from.ch:t(e.from)+l(e.removed.slice(0,r.line-e.from.line))+1+r.ch;var n}}for(var i=[],o=t.length-1;o>=0;o--){var s=t[o],a=(r=n(r,s))(s.from),h=s.removed.join("\n"),u=s.text.join("\n");i.unshift({start:a,end:a+h.length,removed:h,text:u,origin:s.origin})}return i},a.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,r=-1,n=0;n<t.length;n++){var i=t[n],o=i.from.line;i.from.ch;(i.removed.length>1||i.removed[0].indexOf(h)>=0)&&(e=Math.min(e,o),r=Math.max(r,o)),i.text.length>1?(e=Math.min(e,o),r=Math.max(r,o+i.text.length-1)):i.text[0].indexOf(h)>=0&&(e=Math.min(e,o),r=Math.max(r,o))}r=Math.min(r,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,r)},a.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(t<Number.MAX_VALUE)for(;t>0&&this.lineIsListItemOrIndented_(t-1);)t--;if(e>-1)for(var r=this.codeMirror.lineCount();e+1<r&&this.lineIsListItemOrIndented_(e+1);)e++;for(var n=[],i=this.codeMirror,o=t;o<=e;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),s.length>0)for(var u=s.indexOf(h);u>=0;){for(var c=u;u<s.length&&s[u]===h;){for(var p=i.findMarksAt({line:o,ch:u}),l=0;l<p.length;l++)p[l].isForLineSentinel&&p[l].clear();u++}this.markLineSentinelCharacters_(o,c,u,n),u=s.indexOf(h,u)}else n=[]}return e},a.prototype.markLineSentinelCharacters_=function(t,e,r,n){var o=this.codeMirror,s=null,a=null,h=function(){var t=a.find();return t?t.from.line:null};if(0===e){var u=this.getLineAttributes_(t),c=u[i.LIST_TYPE],p=u[i.LINE_INDENT]||0;for(c&&0===p&&(p=1);p>=n.length;)n.push(1);"o"===c?(s=this.makeOrderedListElement_(n[p]),n[p]++):"u"===c?(s=this.makeUnorderedListElement_(),n[p]=1):"t"===c?(s=this.makeTodoListElement_(!1,h),n[p]=1):"tc"===c&&(s=this.makeTodoListElement_(!0,h),n[p]=1);var l=this.getClassNameForAttributes_(u);""!==l&&this.codeMirror.addLineClass(t,"text",l),n[p+1]=1}var d={inclusiveLeft:!0,collapsed:!0};s&&(d.replacedWith=s),(a=o.markText({line:t,ch:e},{line:t,ch:r},d)).isForLineSentinel=!0},a.prototype.makeOrderedListElement_=function(t){return n.elt("div",t+".",{class:"firepad-list-left"})},a.prototype.makeUnorderedListElement_=function(){return n.elt("div","•",{class:"firepad-list-left"})},a.prototype.toggleTodo=function(t){var e,r=i.LIST_TYPE,n=this.getCurrentLineAttributes_();r in n&&("t"===n[r]||"tc"===n[r])?"t"===n[r]?e="tc":"tc"===n[r]&&(e=!!t&&"t"):e="t",this.setLineAttribute(r,e)},a.prototype.makeTodoListElement_=function(t,e){var r={type:"checkbox",class:"firepad-todo-left"};t&&(r.checked=!0);var i=n.elt("input",!1,r),o=this;return n.on(i,"click",n.stopEventAnd(function(t){o.codeMirror.setCursor({line:e(),ch:1}),o.toggleTodo(!0)})),i},a.prototype.lineIsListItemOrIndented_=function(t){var e=this.getLineAttributes_(t);return!1!==(e[i.LIST_TYPE]||!1)||0!==(e[i.LINE_INDENT]||0)},a.prototype.onCursorActivity_=function(){var t=this;setTimeout(function(){t.updateCurrentAttributes_()},1)},a.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},a.prototype.updateCurrentAttributes_=function(){var e=this.codeMirror,r=e.indexFromPos(e.getCursor("anchor")),n=e.indexFromPos(e.getCursor("head")),o=n;if(r>n){for(;o<this.end();){var s=this.getRange(o,o+1);if("\n"!==s&&s!==h)break;o++}o<this.end()&&o++}else for(;o>0&&("\n"===(s=this.getRange(o-1,o))||s===h);)o--;var a=this.annotationList_.getAnnotatedSpansForPos(o);this.currentAttributes_={};var u={};for(var c in a.length>0&&!(i.LINE_SENTINEL in a[0].annotation.attributes)?u=a[0].annotation.attributes:a.length>1&&(t.utils.assert(!(i.LINE_SENTINEL in a[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),u=a[1].annotation.attributes),u)"l"!==c&&"lt"!==c&&"li"!==c&&0!==c.indexOf(i.ENTITY_SENTINEL)&&(this.currentAttributes_[c]=u[c])},a.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),r=t.getCursor("head"),n=r.line;return 0===r.ch&&e.line<r.line&&n--,this.getLineAttributes_(n)},a.prototype.getLineAttributes_=function(e){var n={},i=this.codeMirror.getLine(e);if(i.length>0&&i[0]===h){var o=this.codeMirror.indexFromPos({line:e,ch:0}),s=this.annotationList_.getAnnotatedSpansForSpan(new r(o,1));for(var a in t.utils.assert(1===s.length),s[0].annotation.attributes)n[a]=s[0].annotation.attributes[a]}return n},a.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new r(0,this.end()),function(t,e){return new d({})})},a.prototype.newline=function(){var t=this.codeMirror,e=this;if(this.emptySelection_()){var r=t.getCursor("head").line,n=this.getLineAttributes_(r),o=n[i.LIST_TYPE];o&&1===t.getLine(r).length?this.updateLineAttributes(r,r,function(t){delete t[i.LIST_TYPE],delete t[i.LINE_INDENT]}):(t.replaceSelection("\n","end","+input"),this.updateLineAttributes(r+1,r+1,function(t){for(var s in n)t[s]=n[s];"tc"===o&&(t[i.LIST_TYPE]="t"),e.trigger("newLine",{line:r+1,attr:t})}))}else t.replaceSelection("\n","end","+input")},a.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),r=this.getLineAttributes_(e.line),n=r[i.LIST_TYPE],o=r[i.LINE_INDENT],s=this.emptySelection_()&&1===e.ch;s&&n?this.updateLineAttributes(e.line,e.line,function(t){delete t[i.LIST_TYPE],delete t[i.LINE_INDENT]}):s&&o&&o>0?this.unindent():t.deleteH(-1,"char")},a.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),r=t.getLine(e.line),n=this.areLineSentinelCharacters_(r),i=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&n&&i[0]===h?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")},a.prototype.indent=function(){this.updateLineAttributesForSelection(function(t){var e=t[i.LINE_INDENT],r=t[i.LIST_TYPE];e?t[i.LINE_INDENT]++:t[i.LINE_INDENT]=r?2:1})},a.prototype.unindent=function(){this.updateLineAttributesForSelection(function(t){var e=t[i.LINE_INDENT];e&&e>1?t[i.LINE_INDENT]=e-1:(delete t[i.LIST_TYPE],delete t[i.LINE_INDENT])})},a.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(h,"g"),"")},a.prototype.areLineSentinelCharacters_=function(t){for(var e=0;e<t.length;e++)if(t[e]!==h)return!1;return!0},d.prototype.equals=function(t){if(!(t instanceof d))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},a}(),(t=t||{}).RichTextCodeMirrorAdapter=function(){"use strict";var e=t.TextOperation,r=t.WrappedOperation,n=t.Cursor;function i(t){this.rtcm=t,this.cm=t.codeMirror,h(this,"onChange"),h(this,"onAttributesChange"),h(this,"onCursorActivity"),h(this,"onFocus"),h(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function o(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function s(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function a(t,e){if(!t)throw new Error(e||"assertion error")}function h(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}function u(t){for(var e in t)return!1;return!0}function c(t,e){if("string"!=typeof t)throw new TypeError("Expected a string");3===(t=t.replace(/^#/,"")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var r,n=parseInt(t,16),i=[n>>16,n>>8&255,255&n],o="rgb";return null!==(r=e)&&void 0!==r&&(o="rgba",i.push(e)),o+"("+i.join(",")+")"}return i.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},i.operationFromCodeMirrorChanges=function(t,r){for(var n=s(r),i=(new e).retain(n),o=(new e).retain(n),a=t.length-1;a>=0;a--){var h=t[a],u=h.start,c=n-u-h.text.length;i=(new e).retain(u).delete(h.removed.length).insert(h.text,h.attributes).retain(c).compose(i),o=o.compose((new e).retain(u).delete(h.text.length).insert(h.removed,h.removedAttributes).retain(c)),n+=h.removed.length-h.text.length}return[i,o]},i.operationFromAttributesChanges=function(t,r){for(var n=s(r),i=new e,o=new e,h=0,u=0;u<t.length;u++){var c=t[u],p=c.start-h;a(p>=0),i.retain(p),o.retain(p);var l=c.end-c.start;i.retain(l,c.attributes),o.retain(l,c.attributesInverse),h=c.start+l}return i.retain(n-h),o.retain(n-h),[i,o]},i.prototype.registerCallbacks=function(t){this.callbacks=t},i.prototype.onChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=i.operationFromCodeMirrorChanges(e,this.cm);this.trigger("change",r[0],r[1])}},i.prototype.onAttributesChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=i.operationFromAttributesChanges(e,this.cm);this.trigger("change",r[0],r[1])}},i.prototype.onCursorActivity=function(){var t=this;setTimeout(function(){t.trigger("cursorActivity")},1)},i.prototype.onFocus=function(){this.trigger("focus")},i.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},i.prototype.getValue=function(){return this.cm.getValue()},i.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),i=e.indexFromPos(r);if(e.somethingSelected()){var s=e.getCursor(!0),a=0===o(r,s)?e.getCursor(!1):s;t=e.indexFromPos(a)}else t=i;return new n(i,t)},i.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))},i.prototype.addStyleRule=function(t){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet}if(!this.addedStyleRules[t])return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},i.prototype.setOtherCursor=function(t,e,r){var n=this.cm.posFromIndex(t.position);if("string"==typeof e&&e.match(/^#[a-fA-F0-9]{3,6}$/)){var i=this.rtcm.end();if("object"==typeof t&&"number"==typeof t.position&&"number"==typeof t.selectionEnd&&!(t.position<0||t.position>i||t.selectionEnd<0||t.selectionEnd>i)){if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(n),s=document.createElement("span");return s.className="other-client",s.style.borderLeftWidth="2px",s.style.borderLeftStyle="solid",s.style.borderLeftColor=e,s.style.marginLeft=s.style.marginRight="-1px",s.style.height=.9*(o.bottom-o.top)+"px",s.setAttribute("data-clientid",r),s.style.zIndex=0,this.cm.setBookmark(n,{widget:s,insertLeft:!0})}var a,h,u="selection-"+e.replace("#",""),p="."+u+" { background: "+c(e)+";\n background: "+c(e,.4)+";}";return this.addStyleRule(p),t.selectionEnd>t.position?(a=n,h=this.cm.posFromIndex(t.selectionEnd)):(a=this.cm.posFromIndex(t.selectionEnd),h=n),this.cm.markText(a,h,{className:u})}}},i.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},i.prototype.applyOperation=function(t){t.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,r=0,n=0,i=e.length;n<i;n++){var o=e[n];o.isRetain()?(u(o.attributes)||this.rtcm.updateTextAttributes(r,r+o.chars,function(t){for(var e in o.attributes)!1===o.attributes[e]?delete t[e]:t[e]=o.attributes[e]},"RTCMADAPTER",!0),r+=o.chars):o.isInsert()?(this.rtcm.insertText(r,o.text,o.attributes,"RTCMADAPTER"),r+=o.text.length):o.isDelete()&&this.rtcm.removeText(r,r+o.chars,"RTCMADAPTER")}t.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},i.prototype.registerUndo=function(t){this.cm.undo=t},i.prototype.registerRedo=function(t){this.cm.redo=t},i.prototype.invertOperation=function(t){for(var n,i,o=0,s=this.rtcm.codeMirror,a=new e,h=0;h<t.wrapped.ops.length;h++){var c=t.wrapped.ops[h];if(c.isRetain())if(u(c.attributes))a.retain(c.chars),o+=c.chars;else for(n=this.rtcm.getAttributeSpans(o,o+c.chars),i=0;i<n.length;i++){var p={};for(var l in c.attributes){var d=c.attributes[l],f=n[i].attributes[l];!1===d?f&&(p[l]=f):d!==f&&(p[l]=f||!1)}a.retain(n[i].length,p),o+=n[i].length}else if(c.isInsert())a.delete(c.text.length);else if(c.isDelete()){var g=s.getRange(s.posFromIndex(o),s.posFromIndex(o+c.chars));n=this.rtcm.getAttributeSpans(o,o+c.chars);var y=0;for(i=0;i<n.length;i++)a.insert(g.substr(y,n[i].length),n[i].attributes),y+=n[i].length;o+=c.chars}}return new r(a,t.meta.invert())},i}(),(t=t||{}).Formatting=function(){var e=t.AttributeConstants;function r(t){if(!(this instanceof r))return new r(t);this.attributes=t||{}}return r.prototype.cloneWithNewAttribute_=function(t,e){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return!1===e?delete n[t]:n[t]=e,new r(n)},r.prototype.bold=function(t){return this.cloneWithNewAttribute_(e.BOLD,t)},r.prototype.italic=function(t){return this.cloneWithNewAttribute_(e.ITALIC,t)},r.prototype.underline=function(t){return this.cloneWithNewAttribute_(e.UNDERLINE,t)},r.prototype.strike=function(t){return this.cloneWithNewAttribute_(e.STRIKE,t)},r.prototype.font=function(t){return this.cloneWithNewAttribute_(e.FONT,t)},r.prototype.fontSize=function(t){return this.cloneWithNewAttribute_(e.FONT_SIZE,t)},r.prototype.color=function(t){return this.cloneWithNewAttribute_(e.COLOR,t)},r.prototype.backgroundColor=function(t){return this.cloneWithNewAttribute_(e.BACKGROUND_COLOR,t)},r}(),(t=t||{}).Text=function(){return function e(r,n){if(!(this instanceof e))return new e(r,n);this.text=r,this.formatting=n||t.Formatting()}}(),(t=t||{}).LineFormatting=function(){var e=t.AttributeConstants;function r(t){if(!(this instanceof r))return new r(t);this.attributes=t||{},this.attributes[e.LINE_SENTINEL]=!0}return r.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},r.prototype.cloneWithNewAttribute_=function(t,e){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return!1===e?delete n[t]:n[t]=e,new r(n)},r.prototype.indent=function(t){return this.cloneWithNewAttribute_(e.LINE_INDENT,t)},r.prototype.align=function(t){return this.cloneWithNewAttribute_(e.LINE_ALIGN,t)},r.prototype.listItem=function(r){return t.utils.assert(!1===r||"u"===r||"o"===r||"t"===r||"tc"===r),this.cloneWithNewAttribute_(e.LIST_TYPE,r)},r.prototype.getIndent=function(){return this.attributes[e.LINE_INDENT]||0},r.prototype.getAlign=function(){return this.attributes[e.LINE_ALIGN]||0},r.prototype.getListItem=function(){return this.attributes[e.LIST_TYPE]||!1},r}(),(t=t||{}).Line=function(){return function e(r,n){if(!(this instanceof e))return new e(r,n);"[object Array]"!==Object.prototype.toString.call(r)&&(r=void 0===r?[]:[r]),this.textPieces=r,this.formatting=n||t.LineFormatting()}}(),(t=t||{}).ParseHtml=function(){var e,r=t.LineFormatting.LIST_TYPE;function n(e,n,i){this.listType=e||r.UNORDERED,this.lineFormatting=n||t.LineFormatting(),this.textFormatting=i||t.Formatting()}function i(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}n.prototype.withTextFormatting=function(t){return new n(this.listType,this.lineFormatting,t)},n.prototype.withLineFormatting=function(t){return new n(this.listType,t,this.textFormatting)},n.prototype.withListType=function(t){return new n(t,this.lineFormatting,this.textFormatting)},n.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new n(this.listType,t,this.textFormatting)},n.prototype.withAlign=function(t){var e=this.lineFormatting.align(t);return new n(this.listType,e,this.textFormatting)},i.prototype.newlineIfNonEmpty=function(t){this.cleanLine_(),this.currentLine.length>0&&this.newline(t)},i.prototype.newlineIfNonEmptyOrListItem=function(t){this.cleanLine_(),(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(t)},i.prototype.newline=function(e){this.cleanLine_();var r=e.lineFormatting;null!==this.currentLineListItemType&&(r=r.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(t.Line(this.currentLine,r)),this.currentLine=[]},i.prototype.makeListItem=function(t){this.currentLineListItemType=t},i.prototype.cleanLine_=function(){if(this.currentLine.length>0){var t=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[t].text=this.currentLine[t].text.replace(/ +$/g,"");for(var e=0;e<this.currentLine.length;e++)this.currentLine[e].text=this.currentLine[e].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var o=o||{ELEMENT_NODE:1,TEXT_NODE:3};function s(n,i,s){if(n.nodeType===o.ELEMENT_NODE){var h=e.fromElement(n);if(h)return void s.currentLine.push(new t.Text(t.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new t.Formatting(h.toAttributes())))}switch(n.nodeType){case o.TEXT_NODE:var u=n.nodeValue.replace(/[ \n\t]+/g," ");s.currentLine.push(t.Text(u,i.textFormatting));break;case o.ELEMENT_NODE:switch(i=function(e,r){for(var n=e.textFormatting,i=e.lineFormatting,o=r.split(";"),s=0;s<o.length;s++){var a=o[s].split(":");if(2===a.length){var h=t.utils.trim(a[0]).toLowerCase(),u=t.utils.trim(a[1]).toLowerCase();switch(h){case"text-decoration":var c=u.indexOf("underline")>=0,p=u.indexOf("line-through")>=0;n=n.underline(c).strike(p);break;case"font-weight":var l="bold"===u||parseInt(u)>=600;n=n.bold(l);break;case"font-style":var d="italic"===u||"oblique"===u;n=n.italic(d);break;case"color":n=n.color(u);break;case"background-color":n=n.backgroundColor(u);break;case"text-align":i=i.align(u);break;case"font-size":var f=null;t.utils.stringEndsWith(u,["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"])?f=u:parseInt(u)&&(f=parseInt(u)+"px"),f&&(n=n.fontSize(f));break;case"font-family":var g=t.utils.trim(u.split(",")[0]);g=(g=g.replace(/['"]/g,"")).replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}),n=n.font(g)}}}return e.withLineFormatting(i).withTextFormatting(n)}(i,n.getAttribute("style")||""),n.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":s.newlineIfNonEmpty(i),a(n,i,s),s.newlineIfNonEmpty(i);break;case"center":i=i.withAlign("center"),s.newlineIfNonEmpty(i),a(n,i.withAlign("center"),s),s.newlineIfNonEmpty(i);break;case"b":case"strong":a(n,i.withTextFormatting(i.textFormatting.bold(!0)),s);break;case"u":a(n,i.withTextFormatting(i.textFormatting.underline(!0)),s);break;case"i":case"em":a(n,i.withTextFormatting(i.textFormatting.italic(!0)),s);break;case"s":a(n,i.withTextFormatting(i.textFormatting.strike(!0)),s);break;case"font":var c=n.getAttribute("face"),p=n.getAttribute("color"),l=parseInt(n.getAttribute("size"));c&&(i=i.withTextFormatting(i.textFormatting.font(c))),p&&(i=i.withTextFormatting(i.textFormatting.color(p))),l&&(i=i.withTextFormatting(i.textFormatting.fontSize(l))),a(n,i,s);break;case"br":s.newline(i);break;case"ul":s.newlineIfNonEmptyOrListItem(i);var d="firepad-todo"===n.getAttribute("class")?r.TODO:r.UNORDERED;a(n,i.withListType(d).withIncreasedIndent(),s),s.newlineIfNonEmpty(i);break;case"ol":s.newlineIfNonEmptyOrListItem(i),a(n,i.withListType(r.ORDERED).withIncreasedIndent(),s),s.newlineIfNonEmpty(i);break;case"li":!function(t,e,n){n.newlineIfNonEmptyOrListItem(e);var i="firepad-checked"===t.getAttribute("class")?r.TODOCHECKED:e.listType;n.makeListItem(i);var o=n.currentLine;a(t,e,n),(o===n.currentLine||n.currentLine.length>0)&&n.newline(e)}(n,i,s);break;case"style":break;default:a(n,i,s)}}}function a(t,e,r){if(t.hasChildNodes())for(var n=0;n<t.childNodes.length;n++)s(t.childNodes[n],e,r)}return function(r,o){var a=(t.document||document).createElement("div");a.innerHTML=r,e=o;var h=new i;return s(a,new n,h),h.lines}}(),(t=t||{}).textPiecesToInserts=function(e,r){var n=[];function i(r,i){r instanceof t.Text&&(i=r.formatting.attributes,r=r.text),n.push({string:r,attributes:i}),e="\n"===r[r.length-1]}function o(r,n){e&&i(t.sentinelConstants.LINE_SENTINEL_CHARACTER,r.formatting.attributes);for(var o=0;o<r.textPieces.length;o++)i(r.textPieces[o]);n&&i("\n")}for(var s=0;s<r.length;s++)r[s]instanceof t.Line?o(r[s],s<r.length-1):i(r[s]);return n},(t=t||{}).Firepad=function(e){if(!t.RichTextCodeMirrorAdapter)throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");var r=t.RichTextCodeMirrorAdapter,n=t.RichTextCodeMirror,i=t.RichTextToolbar,o=t.ACEAdapter,s=t.MonacoAdapter,a=(t.FirebaseAdapter,t.EditorClient),h=t.EntityManager,u=t.AttributeConstants,c=t.utils,p=(t.LineFormatting.LIST_TYPE,e.CodeMirror),l=e.ace;e.monaco;function d(t,i,u){if(!(this instanceof d))return new d(t,i,u);if(!p&&!l&&!e.monaco)throw new Error("Couldn't find CodeMirror, ACE or Monaco.  Did you forget to include codemirror.js/ace.js or import monaco?");if(this.zombie_=!1,p&&i instanceof p){this.codeMirror_=this.editor_=i;var g=this.codeMirror_.getValue();if(""!==g)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else if(l&&i&&i.session instanceof l.EditSession){if(this.ace_=this.editor_=i,""!==(g=this.ace_.getValue()))throw new Error("Can't initialize Firepad with an ACE instance that already contains text.")}else if(e.monaco&&i&&i instanceof e.monaco.constructor){if(e.monaco,this.monaco_=this.editor_=i,""!==(g=this.monaco_.getValue()))throw new Error("Can't initialize Firepad with a Monaco instance that already contains text.")}else this.codeMirror_=this.editor_=new p(i);var y;y=this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_?this.ace_.container:this.monaco_.getDomNode(),this.firepadWrapper_=c.elt("div",null,{class:"firepad"}),y.parentNode.replaceChild(this.firepadWrapper_,y),this.firepadWrapper_.appendChild(y),c.on(y,"dragstart",c.stopEvent),this.editor_.firepad=this,this.options_=u||{},this.getOption("richTextShortcuts",!1)&&(p.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.codeMirror_&&this.codeMirror_.refresh();var m=this.getOption("userId",t.push().key),v=this.getOption("userColor",function(t){for(var e=1,r=0;r<t.length;r++)e=17*(e+t.charCodeAt(r))%360;return function(t,e,r){if(0===e)return f(r,r,r);var n=r<.5?r*(1+e):r+e-e*r,i=2*r-n,o=function(t){return t<0&&(t+=1),t>1&&(t-=1),6*t<1?i+6*(n-i)*t:2*t<1?n:3*t<2?i+6*(n-i)*(2/3-t):i};return f(o(t+1/3),o(t),o(t-1/3))}(e/360,1,.75)}(m));this.entityManager_=new h,this.firebaseAdapter_=new d.FirebaseAdapter(t,m,v),this.codeMirror_?(this.richTextCodeMirror_=new n(this.codeMirror_,this.entityManager_,{cssPrefix:"firepad-"}),this.editorAdapter_=new r(this.richTextCodeMirror_)):this.ace_?this.editorAdapter_=new o(this.ace_):this.editorAdapter_=new s(this.monaco_),this.client_=new a(this.firebaseAdapter_,this.editorAdapter_);var _=this;this.firebaseAdapter_.on("cursor",function(){_.trigger.apply(_,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){_.trigger.apply(_,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){_.ready_=!0,this.ace_&&this.editorAdapter_.grabDocumentState(),this.monaco_&&this.editorAdapter_.grabDocumentState();var t=_.getOption("defaultText",null);t&&_.isHistoryEmpty()&&_.setText(t),_.trigger("ready")}),this.client_.on("synced",function(t){_.trigger("synced",t)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important;}",t.appendChild(e),setTimeout(function(){t.removeChild(e)},0)})}function f(t,e,r){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(r)}return c.makeEventEmitter(d),d.fromCodeMirror=d,d.fromACE=d,d.fromMonaco=d,d.prototype.dispose=function(){this.zombie_=!0,this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),this.firepadWrapper_.removeChild(editorWrapper),this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_),this.editor_.firepad=null,this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},d.prototype.setUserId=function(t){this.firebaseAdapter_.setUserId(t)},d.prototype.setUserColor=function(t){this.firebaseAdapter_.setColor(t)},d.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_?this.richTextCodeMirror_.getText():this.ace_?this.ace_.getSession().getDocument().getValue():this.monaco_.getModel().getValue()},d.prototype.setText=function(t){return this.assertReady_("setText"),this.monaco_?this.monaco_.getModel().setValue(t):this.ace_?this.ace_.getSession().getDocument().setValue(t):(this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,t),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),void this.editorAdapter_.setCursor({position:0,selectionEnd:0}))},d.prototype.insertTextAtCursor=function(t){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},d.prototype.insertText=function(e,r){c.assert(!this.ace_,"Not supported for ace yet."),c.assert(!this.monaco_,"Not supported for monaco yet."),this.assertReady_("insertText"),"[object Array]"!==Object.prototype.toString.call(r)&&(r=[r]);var n=this;n.codeMirror_.operation(function(){for(var i=0===e,o=t.textPiecesToInserts(i,r),s=0;s<o.length;s++){var a=o[s].string,h=o[s].attributes;n.richTextCodeMirror_.insertText(e,a,h),e+=a.length}})},d.prototype.getOperationForSpan=function(e,r){for(var n=this.richTextCodeMirror_.getRange(e,r),i=this.richTextCodeMirror_.getAttributeSpans(e,r),o=0,s=new t.TextOperation,a=0;a<i.length;a++)s.insert(n.substr(o,i[a].length),i[a].attributes),o+=i[a].length;return s},d.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},d.prototype.getHtmlFromSelection=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),r=this.codeMirror_.indexFromPos(t),n=this.codeMirror_.indexFromPos(e);return this.getHtmlFromRange(r,n)},d.prototype.getHtmlFromRange=function(e,r){this.assertReady_("getHtmlFromRange");var n=null!=e&&null!=r?this.getOperationForSpan(e,r):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return t.SerializeHtml(n,this.entityManager_)},d.prototype.insertHtml=function(e,r){var n=t.ParseHtml(r,this.entityManager_);this.insertText(e,n)},d.prototype.insertHtmlAtCursor=function(t){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},d.prototype.setHtml=function(e){var r=t.ParseHtml(e,this.entityManager_);this.setText(r)},d.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},d.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(u.BOLD),this.codeMirror_.focus()},d.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(u.ITALIC),this.codeMirror_.focus()},d.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(u.UNDERLINE),this.codeMirror_.focus()},d.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(u.STRIKE),this.codeMirror_.focus()},d.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute(u.FONT_SIZE,t),this.codeMirror_.focus()},d.prototype.font=function(t){this.richTextCodeMirror_.setAttribute(u.FONT,t),this.codeMirror_.focus()},d.prototype.color=function(t){this.richTextCodeMirror_.setAttribute(u.COLOR,t),this.codeMirror_.focus()},d.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(u.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),this.codeMirror_.focus()},d.prototype.align=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(u.LINE_ALIGN,t),this.codeMirror_.focus()},d.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(u.LIST_TYPE,"o"),this.codeMirror_.focus()},d.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(u.LIST_TYPE,"u"),this.codeMirror_.focus()},d.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},d.prototype.newline=function(){this.richTextCodeMirror_.newline()},d.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},d.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},d.prototype.indent=function(){this.richTextCodeMirror_.indent(),this.codeMirror_.focus()},d.prototype.unindent=function(){this.richTextCodeMirror_.unindent(),this.codeMirror_.focus()},d.prototype.undo=function(){this.codeMirror_.undo()},d.prototype.redo=function(){this.codeMirror_.redo()},d.prototype.insertEntity=function(t,e,r){this.richTextCodeMirror_.insertEntityAtCursor(t,e,r)},d.prototype.insertEntityAt=function(t,e,r,n){this.richTextCodeMirror_.insertEntityAt(t,e,r,n)},d.prototype.registerEntity=function(t,e){this.entityManager_.register(t,e)},d.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},d.prototype.assertReady_=function(t){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+t+"]")},d.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},d.prototype.makeDialog_=function(t,e){var r=this,n=c.elt("input",null,{class:"firepad-dialog-input",id:t,type:"text",placeholder:e,autofocus:"autofocus"}),i=c.elt("a","Submit",{class:"firepad-btn",id:"submitbtn"});c.on(i,"click",c.stopEventAnd(function(){var e=document.getElementById("overlay");e.style.visibility="hidden";var n=document.getElementById(t).value;null!==n&&r.insertEntity(t,{src:n}),r.firepadWrapper_.removeChild(e)}));var o=c.elt("a","Cancel",{class:"firepad-btn"});c.on(o,"click",c.stopEventAnd(function(){var t=document.getElementById("overlay");t.style.visibility="hidden",r.firepadWrapper_.removeChild(t)}));var s=c.elt("div",[i,o],{class:"firepad-btn-group"}),a=c.elt("div",[n,s],{class:"firepad-dialog-div"}),h=c.elt("div",[a],{class:"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(h)},d.prototype.addToolbar_=function(){this.toolbar=new i(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},d.prototype.addPoweredByLogo_=function(){var t=c.elt("a",null,{class:"powered-by-firepad"});t.setAttribute("href","http://www.firepad.io/"),t.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(t)},d.prototype.initializeKeyMap_=function(){function t(t){return function(e){setTimeout(function(){t.call(e.firepad)},0)}}p.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),"Ctrl-H":t(this.highlight),"Cmd-H":t(this.highlight),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},d}(this),t.Firepad.Formatting=t.Formatting,t.Firepad.Text=t.Text,t.Firepad.Entity=t.Entity,t.Firepad.LineFormatting=t.LineFormatting,t.Firepad.Line=t.Line,t.Firepad.TextOperation=t.TextOperation,t.Firepad.Headless=t.Headless,t.Firepad.RichTextCodeMirrorAdapter=t.RichTextCodeMirrorAdapter,t.Firepad.ACEAdapter=t.ACEAdapter,t.Firepad.MonacoAdapter=t.MonacoAdapter,t.Firepad},this);